<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRYPTO FUNDING ARB &lt;GO&gt;</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a12;
            --bg-panel: #0d0d18;
            --bg-input: #14141f;

            --bloomberg-orange: #ff6600;
            --bloomberg-amber: #ffaa00;
            --bloomberg-yellow: #ffdd00;

            --text-white: #ffffff;
            --text-amber: #ffcc00;
            --text-gray: #888899;
            --text-dark: #555566;

            --positive: #00dd00;
            --negative: #ff3333;
            --neutral: #00aaff;

            --border-color: #2a2a3a;
            --border-bright: #3a3a4a;

            --font-mono: 'IBM Plex Mono', 'Consolas', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-mono);
            background: var(--bg-primary);
            color: var(--text-white);
            font-size: 12px;
            line-height: 1.4;
            min-height: 100vh;
        }

        /* Top Menu Bar */
        .top-bar {
            background: linear-gradient(180deg, #1a1a2e 0%, #0d0d18 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 4px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            color: var(--bloomberg-orange);
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 1px;
        }

        .menu-items {
            display: flex;
            gap: 2px;
        }

        .menu-item {
            padding: 4px 10px;
            color: var(--text-amber);
            font-size: 11px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .menu-item:hover {
            background: var(--bg-input);
            border-color: var(--border-color);
        }

        .menu-item.active {
            background: var(--bloomberg-orange);
            color: #000;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text-gray);
            font-size: 11px;
        }

        .clock {
            color: var(--bloomberg-yellow);
            font-weight: 600;
        }

        /* Command Line */
        .command-line {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .command-prompt {
            color: var(--bloomberg-orange);
            font-weight: 700;
        }

        .command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--bloomberg-yellow);
            font-family: var(--font-mono);
            font-size: 13px;
            outline: none;
        }

        .command-input::placeholder {
            color: var(--text-dark);
        }

        .go-button {
            background: var(--bloomberg-orange);
            color: #000;
            border: none;
            padding: 4px 12px;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 11px;
            cursor: pointer;
        }

        .go-button:hover {
            background: var(--bloomberg-amber);
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 1px;
            background: var(--border-color);
            padding: 1px;
        }

        /* Panel Styles */
        .panel {
            background: var(--bg-panel);
            position: relative;
        }

        .panel-header {
            background: linear-gradient(180deg, #1a1a2e 0%, #12121c 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 6px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-number {
            background: var(--bloomberg-orange);
            color: #000;
            padding: 1px 5px;
            font-size: 10px;
            font-weight: 700;
        }

        .panel-name {
            color: var(--bloomberg-amber);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .panel-action {
            color: var(--text-dark);
            font-size: 10px;
            cursor: pointer;
        }

        .panel-action:hover {
            color: var(--bloomberg-orange);
        }

        .panel-body {
            padding: 8px;
        }

        /* P&L Summary - Full Width Top */
        .pnl-panel {
            grid-column: 1 / -1;
        }

        .pnl-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: var(--border-color);
        }

        .pnl-item {
            background: var(--bg-primary);
            padding: 12px 15px;
            text-align: center;
        }

        .pnl-label {
            color: var(--text-gray);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .pnl-value {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .pnl-value.positive { color: var(--positive); }
        .pnl-value.negative { color: var(--negative); }

        .pnl-sub {
            color: var(--text-dark);
            font-size: 10px;
            margin-top: 4px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .data-table th {
            background: var(--bg-secondary);
            color: var(--text-gray);
            font-weight: 500;
            text-align: left;
            padding: 6px 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .data-table td {
            padding: 5px 8px;
            border-bottom: 1px solid #1a1a25;
            white-space: nowrap;
        }

        .data-table tbody tr:hover {
            background: var(--bg-input);
        }

        .data-table tbody tr:nth-child(odd) {
            background: rgba(255, 255, 255, 0.01);
        }

        .positive { color: var(--positive); }
        .negative { color: var(--negative); }
        .amber { color: var(--bloomberg-amber); }
        .orange { color: var(--bloomberg-orange); }

        /* Exchange Tags */
        .exchange-tag {
            display: inline-block;
            padding: 2px 6px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.3px;
            border: 1px solid;
        }

        .tag-binance {
            color: #f0b90b;
            border-color: #f0b90b;
            background: rgba(240, 185, 11, 0.1);
        }
        .tag-bybit {
            color: #f7a600;
            border-color: #f7a600;
            background: rgba(247, 166, 0, 0.1);
        }
        .tag-okx {
            color: #aaaaaa;
            border-color: #666666;
            background: rgba(255, 255, 255, 0.05);
        }
        .tag-dydx {
            color: #6966ff;
            border-color: #6966ff;
            background: rgba(105, 102, 255, 0.1);
        }

        /* Countdown */
        .countdown-cell {
            font-variant-numeric: tabular-nums;
            color: var(--neutral);
        }

        .countdown-cell.urgent {
            color: var(--negative);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        /* Calculator Panel */
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .calc-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .calc-field label {
            color: var(--text-gray);
            font-size: 10px;
            text-transform: uppercase;
        }

        .calc-field input,
        .calc-field select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--bloomberg-yellow);
            font-family: var(--font-mono);
            font-size: 12px;
            padding: 6px 8px;
        }

        .calc-field input:focus,
        .calc-field select:focus {
            outline: none;
            border-color: var(--bloomberg-orange);
        }

        .calc-results {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
        }

        .calc-result-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            border-bottom: 1px solid #1a1a25;
        }

        .calc-result-row:last-child {
            border-bottom: none;
        }

        .calc-result-label {
            color: var(--text-gray);
            font-size: 10px;
            text-transform: uppercase;
        }

        .calc-result-value {
            font-weight: 600;
            font-size: 12px;
        }

        .calc-result-row.highlight {
            background: rgba(255, 102, 0, 0.1);
        }

        .calc-result-row.highlight .calc-result-value {
            color: var(--bloomberg-orange);
            font-size: 14px;
        }

        /* Chart Panel */
        .chart-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 8px;
        }

        .chart-tab {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-gray);
            padding: 4px 12px;
            font-family: var(--font-mono);
            font-size: 10px;
            cursor: pointer;
        }

        .chart-tab:hover {
            border-color: var(--bloomberg-orange);
            color: var(--bloomberg-amber);
        }

        .chart-tab.active {
            background: var(--bloomberg-orange);
            border-color: var(--bloomberg-orange);
            color: #000;
            font-weight: 600;
        }

        .chart-container {
            height: 200px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 10px;
        }

        /* Position buttons */
        .btn-close {
            background: transparent;
            border: 1px solid var(--negative);
            color: var(--negative);
            padding: 3px 8px;
            font-family: var(--font-mono);
            font-size: 9px;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-close:hover {
            background: var(--negative);
            color: #000;
        }

        /* Status indicator */
        .status-live {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--positive);
            font-size: 9px;
            text-transform: uppercase;
        }

        .status-live::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--positive);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Function Keys Footer */
        .function-bar {
            background: linear-gradient(180deg, #1a1a2e 0%, #0d0d18 100%);
            border-top: 1px solid var(--border-color);
            padding: 6px 10px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .fn-key {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
        }

        .fn-key-label {
            color: var(--bloomberg-amber);
            font-size: 9px;
            font-weight: 600;
        }

        .fn-key-text {
            color: var(--text-gray);
            font-size: 9px;
        }

        /* Ticker Tape */
        .ticker-tape {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 4px 0;
            overflow: hidden;
            white-space: nowrap;
        }

        .ticker-content {
            display: inline-block;
            animation: ticker 30s linear infinite;
        }

        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .ticker-item {
            display: inline-block;
            margin-right: 30px;
            font-size: 11px;
        }

        .ticker-symbol {
            color: var(--bloomberg-amber);
            font-weight: 600;
        }

        .ticker-price {
            color: var(--text-white);
            margin: 0 6px;
        }

        .ticker-change {
            font-size: 10px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-bright);
        }

        /* Panel scroll */
        .panel-scroll {
            max-height: 250px;
            overflow-y: auto;
        }

        /* Engine Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }

        .status-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 8px 10px;
            text-align: center;
        }

        .status-label {
            display: block;
            color: var(--text-gray);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .status-value {
            display: block;
            font-size: 12px;
            font-weight: 600;
        }

        .status-error {
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid var(--negative);
            color: var(--negative);
            font-size: 10px;
        }

        .text-gray { color: var(--text-gray); }

        /* Action Buttons Grid */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .btn-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 12px 8px;
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            border: 1px solid;
            background: var(--bg-primary);
            transition: all 0.15s ease;
        }

        .btn-icon {
            font-size: 16px;
        }

        .btn-start {
            color: var(--positive);
            border-color: var(--positive);
        }
        .btn-start:hover {
            background: var(--positive);
            color: #000;
        }

        .btn-stop {
            color: var(--bloomberg-amber);
            border-color: var(--bloomberg-amber);
        }
        .btn-stop:hover {
            background: var(--bloomberg-amber);
            color: #000;
        }

        .btn-scan {
            color: var(--neutral);
            border-color: var(--neutral);
        }
        .btn-scan:hover {
            background: var(--neutral);
            color: #000;
        }

        .btn-kill {
            color: var(--negative);
            border-color: var(--negative);
        }
        .btn-kill:hover {
            background: var(--negative);
            color: #000;
        }

        /* Connection Status */
        .status-disconnected {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--negative);
            font-size: 9px;
            text-transform: uppercase;
        }

        .status-disconnected::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--negative);
            border-radius: 50%;
        }

        /* Notifications */
        .notifications-container {
            position: fixed;
            top: 60px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
        }

        .notification {
            padding: 10px 14px;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            font-size: 11px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        .notification-info {
            border-left: 3px solid var(--neutral);
            color: var(--text-white);
        }

        .notification-warning {
            border-left: 3px solid var(--bloomberg-amber);
            color: var(--bloomberg-amber);
        }

        .notification-error {
            border-left: 3px solid var(--negative);
            color: var(--negative);
        }

        .notification-critical {
            border-left: 3px solid var(--negative);
            background: rgba(255, 51, 51, 0.2);
            color: var(--negative);
            animation: slideIn 0.3s ease, blink 0.5s infinite;
        }

        .notification.fade-out {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .pnl-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .pnl-grid {
                grid-template-columns: 1fr;
            }

            .top-bar-left .menu-items {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="logo">FUNDING ARB</div>
            <div class="menu-items">
                <div class="menu-item active">MONITOR</div>
                <div class="menu-item">POSITIONS</div>
                <div class="menu-item">ANALYTICS</div>
                <div class="menu-item">SETTINGS</div>
            </div>
        </div>
        <div class="top-bar-right">
            <span class="status-live" id="connection-status">LIVE</span>
            <span>NYC</span>
            <span class="clock" id="clock">00:00:00</span>
        </div>
    </div>

    <!-- Ticker Tape -->
    <div class="ticker-tape">
        <div class="ticker-content" id="ticker">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Command Line -->
    <div class="command-line">
        <span class="command-prompt">&gt;</span>
        <input type="text" class="command-input" placeholder="Type command or security... (e.g., BTC FUNDING, ETH ARB)" id="commandInput">
        <button class="go-button">&lt;GO&gt;</button>
    </div>

    <!-- Main Layout -->
    <div class="main-container">
        <!-- P&L Summary Panel -->
        <div class="panel pnl-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-number">1</span>
                    <span class="panel-name">P&L Summary</span>
                </div>
                <div class="panel-actions">
                    <span class="panel-action">[EXPORT]</span>
                    <span class="panel-action">[REFRESH]</span>
                </div>
            </div>
            <div class="pnl-grid">
                <div class="pnl-item">
                    <div class="pnl-label">Unrealized P&L</div>
                    <div class="pnl-value" id="unrealized-pnl">+$0.00</div>
                    <div class="pnl-sub">Open Positions</div>
                </div>
                <div class="pnl-item">
                    <div class="pnl-label">Realized P&L</div>
                    <div class="pnl-value" id="realized-pnl">+$0.00</div>
                    <div class="pnl-sub">Closed Positions</div>
                </div>
                <div class="pnl-item">
                    <div class="pnl-label">Funding Collected</div>
                    <div class="pnl-value" id="funding-collected">+$0.00</div>
                    <div class="pnl-sub">Cumulative</div>
                </div>
                <div class="pnl-item">
                    <div class="pnl-label">Net P&L</div>
                    <div class="pnl-value" id="net-pnl">+$0.00</div>
                    <div class="pnl-sub">Total Return</div>
                </div>
            </div>
        </div>

        <!-- Funding Rates Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-number">2</span>
                    <span class="panel-name">Live Funding Rates</span>
                </div>
                <div class="panel-actions">
                    <span class="panel-action">[SORT]</span>
                </div>
            </div>
            <div class="panel-body panel-scroll">
                <table class="data-table" id="funding-table">
                    <thead>
                        <tr>
                            <th>Exch</th>
                            <th>Pair</th>
                            <th>Rate</th>
                            <th>Pred</th>
                            <th>APR</th>
                            <th>Next</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Calculator Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-number">3</span>
                    <span class="panel-name">Arbitrage Calculator</span>
                </div>
                <div class="panel-actions">
                    <span class="panel-action">[CLEAR]</span>
                </div>
            </div>
            <div class="panel-body">
                <div class="calc-grid">
                    <div class="calc-field">
                        <label>Size (USD)</label>
                        <input type="number" id="calc-size" value="10000">
                    </div>
                    <div class="calc-field">
                        <label>Leverage</label>
                        <select id="calc-leverage">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="3" selected>3x</option>
                            <option value="5">5x</option>
                            <option value="10">10x</option>
                        </select>
                    </div>
                    <div class="calc-field">
                        <label>Long Rate %</label>
                        <input type="number" id="calc-long-rate" value="-0.0050" step="0.0001">
                    </div>
                    <div class="calc-field">
                        <label>Short Rate %</label>
                        <input type="number" id="calc-short-rate" value="0.0150" step="0.0001">
                    </div>
                </div>
                <div class="calc-results">
                    <div class="calc-result-row">
                        <span class="calc-result-label">Spread</span>
                        <span class="calc-result-value positive" id="calc-spread">0.0200%</span>
                    </div>
                    <div class="calc-result-row">
                        <span class="calc-result-label">Per 8H</span>
                        <span class="calc-result-value positive" id="calc-per-funding">$0.00</span>
                    </div>
                    <div class="calc-result-row">
                        <span class="calc-result-label">Daily</span>
                        <span class="calc-result-value positive" id="calc-daily">$0.00</span>
                    </div>
                    <div class="calc-result-row">
                        <span class="calc-result-label">Weekly</span>
                        <span class="calc-result-value positive" id="calc-weekly">$0.00</span>
                    </div>
                    <div class="calc-result-row">
                        <span class="calc-result-label">Monthly</span>
                        <span class="calc-result-value positive" id="calc-monthly">$0.00</span>
                    </div>
                    <div class="calc-result-row highlight">
                        <span class="calc-result-label">Annual APR</span>
                        <span class="calc-result-value" id="calc-apr">0.00%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-number">4</span>
                    <span class="panel-name">Rate History (7D)</span>
                </div>
            </div>
            <div class="panel-body">
                <div class="chart-tabs">
                    <button class="chart-tab active" onclick="updateChart('BTC')">BTC</button>
                    <button class="chart-tab" onclick="updateChart('ETH')">ETH</button>
                    <button class="chart-tab" onclick="updateChart('SOL')">SOL</button>
                    <button class="chart-tab" onclick="updateChart('ARB')">ARB</button>
                </div>
                <div class="chart-container">
                    <canvas id="fundingChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Active Positions Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-number">5</span>
                    <span class="panel-name">Active Positions</span>
                </div>
                <div class="panel-actions">
                    <span class="panel-action">[NEW]</span>
                </div>
            </div>
            <div class="panel-body panel-scroll">
                <table class="data-table" id="positions-table">
                    <thead>
                        <tr>
                            <th>Pair</th>
                            <th>Size</th>
                            <th>Long</th>
                            <th>Short</th>
                            <th>Entry</th>
                            <th>Fund</th>
                            <th>uPnL</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Closed Positions Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-number">6</span>
                    <span class="panel-name">Closed Positions</span>
                </div>
                <div class="panel-actions">
                    <span class="panel-action">[HISTORY]</span>
                </div>
            </div>
            <div class="panel-body panel-scroll">
                <table class="data-table" id="closed-positions-table">
                    <thead>
                        <tr>
                            <th>Pair</th>
                            <th>Size</th>
                            <th>Long</th>
                            <th>Short</th>
                            <th>Dur</th>
                            <th>Fund</th>
                            <th>rPnL</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Engine Status Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-number">7</span>
                    <span class="panel-name">Engine Status</span>
                </div>
                <div class="panel-actions">
                    <span class="panel-action" onclick="loadEngineStatus()">[REFRESH]</span>
                </div>
            </div>
            <div class="panel-body" id="engine-status-panel">
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">STATE</span>
                        <span class="status-value text-gray">UNKNOWN</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">MODE</span>
                        <span class="status-value amber">SIMULATION</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">KILL SWITCH</span>
                        <span class="status-value positive">OFF</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-number">8</span>
                    <span class="panel-name">Quick Actions</span>
                </div>
            </div>
            <div class="panel-body">
                <div class="action-grid">
                    <button class="btn-action btn-start" onclick="startEngine()">
                        <span class="btn-icon">▶</span>
                        <span>START</span>
                    </button>
                    <button class="btn-action btn-stop" onclick="stopEngine()">
                        <span class="btn-icon">■</span>
                        <span>STOP</span>
                    </button>
                    <button class="btn-action btn-scan" onclick="forceScan()">
                        <span class="btn-icon">⟳</span>
                        <span>SCAN</span>
                    </button>
                    <button class="btn-action btn-kill" onclick="activateKillSwitch()">
                        <span class="btn-icon">⚠</span>
                        <span>KILL</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Container -->
    <div id="notifications" class="notifications-container"></div>

    <!-- Function Keys -->
    <div class="function-bar">
        <div class="fn-key"><span class="fn-key-label">F1</span><span class="fn-key-text">Help</span></div>
        <div class="fn-key"><span class="fn-key-label">F2</span><span class="fn-key-text">Rates</span></div>
        <div class="fn-key"><span class="fn-key-label">F3</span><span class="fn-key-text">Calc</span></div>
        <div class="fn-key"><span class="fn-key-label">F4</span><span class="fn-key-text">Chart</span></div>
        <div class="fn-key"><span class="fn-key-label">F5</span><span class="fn-key-text">Positions</span></div>
        <div class="fn-key"><span class="fn-key-label">F6</span><span class="fn-key-text">History</span></div>
        <div class="fn-key"><span class="fn-key-label">F7</span><span class="fn-key-text">Alerts</span></div>
        <div class="fn-key"><span class="fn-key-label">F8</span><span class="fn-key-text">Export</span></div>
        <div class="fn-key"><span class="fn-key-label">F9</span><span class="fn-key-text">News</span></div>
        <div class="fn-key"><span class="fn-key-label">F10</span><span class="fn-key-text">Settings</span></div>
    </div>

    <script>
        // ============================================================
        // Configuration
        // ============================================================
        const CONFIG = {
            API_BASE_URL: window.location.protocol + '//' + window.location.hostname + ':8000',
            WS_URL: 'ws://' + window.location.hostname + ':8000/ws',
            RECONNECT_DELAY_MS: 1000,
            MAX_RECONNECT_DELAY_MS: 30000,
            REFRESH_INTERVAL_MS: 30000,
        };

        // ============================================================
        // API Client
        // ============================================================
        class APIClient {
            constructor(baseUrl) {
                this.baseUrl = baseUrl;
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseUrl}${endpoint}`;
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            }

            // Health & Status
            async getHealth() { return this.request('/api/health'); }
            async getEngineStatus() { return this.request('/api/engine/status'); }
            async getStats() { return this.request('/api/engine/stats'); }
            async getRiskStatus() { return this.request('/api/engine/risk'); }

            // Positions
            async getOpenPositions() { return this.request('/api/positions/open'); }
            async getClosedPositions(limit = 100) { return this.request(`/api/positions/closed?limit=${limit}`); }
            async getPosition(id) { return this.request(`/api/positions/${id}`); }
            async closePosition(id, reason = 'manual') {
                return this.request(`/api/positions/${id}/close`, {
                    method: 'POST',
                    body: JSON.stringify({ reason })
                });
            }

            // Engine Control
            async startEngine() { return this.request('/api/engine/start', { method: 'POST' }); }
            async stopEngine() { return this.request('/api/engine/stop', { method: 'POST' }); }
            async activateKillSwitch(reason = 'manual') {
                return this.request('/api/engine/kill', {
                    method: 'POST',
                    body: JSON.stringify({ confirm: true, reason })
                });
            }
            async deactivateKillSwitch() { return this.request('/api/engine/kill/deactivate', { method: 'POST' }); }
            async forceScan() { return this.request('/api/engine/scan', { method: 'POST' }); }

            // Funding Rates & Opportunities
            async getFundingRates() { return this.request('/api/engine/rates'); }
            async getOpportunities() { return this.request('/api/engine/opportunities'); }

            // Config
            async getConfig() { return this.request('/api/config'); }
        }

        // ============================================================
        // WebSocket Manager with Reconnection
        // ============================================================
        class WebSocketManager {
            constructor(url, handlers) {
                this.url = url;
                this.handlers = handlers;
                this.ws = null;
                this.reconnectDelay = CONFIG.RECONNECT_DELAY_MS;
                this.isConnected = false;
                this.reconnectTimer = null;
            }

            connect() {
                if (this.ws && (this.ws.readyState === WebSocket.CONNECTING || this.ws.readyState === WebSocket.OPEN)) {
                    return;
                }

                console.log('[WS] Connecting to', this.url);
                this.ws = new WebSocket(this.url);

                this.ws.onopen = () => {
                    console.log('[WS] Connected');
                    this.isConnected = true;
                    this.reconnectDelay = CONFIG.RECONNECT_DELAY_MS;
                    this.updateConnectionStatus(true);
                    if (this.handlers.onConnect) this.handlers.onConnect();
                };

                this.ws.onclose = (event) => {
                    console.log('[WS] Disconnected:', event.code, event.reason);
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    this.scheduleReconnect();
                    if (this.handlers.onDisconnect) this.handlers.onDisconnect();
                };

                this.ws.onerror = (error) => {
                    console.error('[WS] Error:', error);
                };

                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (e) {
                        console.error('[WS] Failed to parse message:', e);
                    }
                };
            }

            handleMessage(data) {
                const { event, payload, timestamp } = data;
                console.log('[WS] Event:', event, payload);

                switch (event) {
                    case 'POSITION_UPDATE':
                        if (this.handlers.onPositionUpdate) this.handlers.onPositionUpdate(payload);
                        break;
                    case 'FUNDING_RATE_UPDATE':
                        if (this.handlers.onFundingRateUpdate) this.handlers.onFundingRateUpdate(payload);
                        break;
                    case 'TRADE_EXECUTED':
                        if (this.handlers.onTradeExecuted) this.handlers.onTradeExecuted(payload);
                        break;
                    case 'ENGINE_STATUS':
                        if (this.handlers.onEngineStatus) this.handlers.onEngineStatus(payload);
                        break;
                    case 'ALERT':
                        if (this.handlers.onAlert) this.handlers.onAlert(payload);
                        break;
                    case 'OPPORTUNITY':
                        if (this.handlers.onOpportunity) this.handlers.onOpportunity(payload);
                        break;
                    default:
                        console.log('[WS] Unknown event:', event);
                }
            }

            scheduleReconnect() {
                if (this.reconnectTimer) return;

                console.log(`[WS] Reconnecting in ${this.reconnectDelay}ms...`);
                this.reconnectTimer = setTimeout(() => {
                    this.reconnectTimer = null;
                    this.connect();
                }, this.reconnectDelay);

                // Exponential backoff
                this.reconnectDelay = Math.min(this.reconnectDelay * 2, CONFIG.MAX_RECONNECT_DELAY_MS);
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    statusEl.className = connected ? 'status-live' : 'status-disconnected';
                    statusEl.innerHTML = connected ? 'LIVE' : 'OFFLINE';
                }
            }

            disconnect() {
                if (this.reconnectTimer) {
                    clearTimeout(this.reconnectTimer);
                    this.reconnectTimer = null;
                }
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
            }
        }

        // ============================================================
        // Application State
        // ============================================================
        const api = new APIClient(CONFIG.API_BASE_URL);
        let wsManager = null;

        // Current data (updated via API/WS)
        const appState = {
            engineStatus: null,
            positions: [],
            closedPositions: [],
            fundingRates: [],
            opportunities: [],
            stats: null,
            connected: false,
        };

        // Mock data for fallback/demo mode
        const mockData = {
            fundingRates: [
                { exchange: 'Binance', pair: 'BTC/USDT', rate: 0.0100, predicted: 0.0085, nextFunding: 14520 },
                { exchange: 'Binance', pair: 'ETH/USDT', rate: 0.0120, predicted: 0.0110, nextFunding: 14520 },
                { exchange: 'Binance', pair: 'SOL/USDT', rate: 0.0250, predicted: 0.0200, nextFunding: 14520 },
                { exchange: 'Bybit', pair: 'BTC/USDT', rate: 0.0080, predicted: 0.0075, nextFunding: 14520 },
                { exchange: 'Bybit', pair: 'ETH/USDT', rate: 0.0095, predicted: 0.0090, nextFunding: 14520 },
                { exchange: 'Bybit', pair: 'SOL/USDT', rate: 0.0180, predicted: 0.0160, nextFunding: 14520 },
                { exchange: 'OKX', pair: 'BTC/USDT', rate: 0.0090, predicted: 0.0082, nextFunding: 14520 },
                { exchange: 'OKX', pair: 'ETH/USDT', rate: 0.0105, predicted: 0.0098, nextFunding: 14520 },
                { exchange: 'dYdX', pair: 'BTC/USD', rate: -0.0050, predicted: -0.0040, nextFunding: 3600 },
                { exchange: 'dYdX', pair: 'ETH/USD', rate: -0.0030, predicted: -0.0025, nextFunding: 3600 },
            ],
            positions: [
                { id: 1, pair: 'BTC/USDT', size: 50000, longExchange: 'dYdX', shortExchange: 'Binance', entryDate: '2024-12-15', fundingCollected: 245.50, unrealizedPnl: 82.30, status: 'active' },
                { id: 2, pair: 'ETH/USDT', size: 30000, longExchange: 'dYdX', shortExchange: 'Bybit', entryDate: '2024-12-18', fundingCollected: 112.80, unrealizedPnl: -15.20, status: 'active' },
                { id: 3, pair: 'SOL/USDT', size: 20000, longExchange: 'Bybit', shortExchange: 'Binance', entryDate: '2024-12-20', fundingCollected: 78.40, unrealizedPnl: 45.60, status: 'active' }
            ],
            closedPositions: [
                { id: 101, pair: 'BTC/USDT', size: 25000, longExchange: 'dYdX', shortExchange: 'OKX', duration: '12d', fundingCollected: 320.00, realizedPnl: 285.50 },
                { id: 102, pair: 'ETH/USDT', size: 15000, longExchange: 'Bybit', shortExchange: 'Binance', duration: '8d', fundingCollected: 145.20, realizedPnl: 122.80 }
            ],
            historicalRates: {
                BTC: {
                    labels: ['Dec 23', 'Dec 24', 'Dec 25', 'Dec 26', 'Dec 27', 'Dec 28', 'Dec 29'],
                    binance: [0.0080, 0.0095, 0.0120, 0.0100, 0.0085, 0.0110, 0.0100],
                    bybit: [0.0070, 0.0082, 0.0105, 0.0088, 0.0075, 0.0095, 0.0080],
                    dydx: [-0.0020, -0.0035, -0.0055, -0.0040, -0.0030, -0.0045, -0.0050]
                },
                ETH: {
                    labels: ['Dec 23', 'Dec 24', 'Dec 25', 'Dec 26', 'Dec 27', 'Dec 28', 'Dec 29'],
                    binance: [0.0100, 0.0115, 0.0140, 0.0125, 0.0110, 0.0130, 0.0120],
                    bybit: [0.0085, 0.0098, 0.0120, 0.0105, 0.0092, 0.0108, 0.0095],
                    dydx: [-0.0015, -0.0025, -0.0040, -0.0030, -0.0022, -0.0035, -0.0030]
                },
                SOL: {
                    labels: ['Dec 23', 'Dec 24', 'Dec 25', 'Dec 26', 'Dec 27', 'Dec 28', 'Dec 29'],
                    binance: [0.0200, 0.0280, 0.0350, 0.0300, 0.0220, 0.0280, 0.0250],
                    bybit: [0.0150, 0.0220, 0.0290, 0.0240, 0.0170, 0.0210, 0.0180],
                    dydx: [0.0050, 0.0080, 0.0120, 0.0090, 0.0060, 0.0085, 0.0070]
                },
                ARB: {
                    labels: ['Dec 23', 'Dec 24', 'Dec 25', 'Dec 26', 'Dec 27', 'Dec 28', 'Dec 29'],
                    binance: [0.0150, 0.0180, 0.0220, 0.0190, 0.0160, 0.0200, 0.0175],
                    bybit: [0.0120, 0.0150, 0.0185, 0.0160, 0.0130, 0.0165, 0.0145],
                    dydx: [0.0030, 0.0050, 0.0080, 0.0060, 0.0040, 0.0065, 0.0055]
                }
            }
        };

        let fundingChart = null;
        let useMockData = false;

        // ============================================================
        // Data Loading Functions
        // ============================================================
        async function loadAllData() {
            try {
                await Promise.all([
                    loadEngineStatus(),
                    loadPositions(),
                    loadStats(),
                ]);
                useMockData = false;
            } catch (error) {
                console.warn('[API] Failed to load data, using mock data:', error);
                useMockData = true;
                // Use mock data
                appState.positions = mockData.positions.filter(p => p.status === 'active');
                appState.closedPositions = mockData.closedPositions;
                appState.fundingRates = mockData.fundingRates;
            }
        }

        async function loadEngineStatus() {
            try {
                appState.engineStatus = await api.getEngineStatus();
                renderEngineStatus();
            } catch (e) {
                console.warn('[API] Failed to load engine status:', e);
            }
        }

        async function loadPositions() {
            try {
                const [open, closed] = await Promise.all([
                    api.getOpenPositions(),
                    api.getClosedPositions(50)
                ]);
                appState.positions = open;
                appState.closedPositions = closed;
            } catch (e) {
                console.warn('[API] Failed to load positions:', e);
                throw e;
            }
        }

        async function loadStats() {
            try {
                appState.stats = await api.getStats();
            } catch (e) {
                console.warn('[API] Failed to load stats:', e);
            }
        }

        // ============================================================
        // WebSocket Event Handlers
        // ============================================================
        const wsHandlers = {
            onConnect: () => {
                appState.connected = true;
                loadAllData();
            },
            onDisconnect: () => {
                appState.connected = false;
            },
            onPositionUpdate: (payload) => {
                // Update position in state
                const idx = appState.positions.findIndex(p => p.id === payload.id);
                if (idx >= 0) {
                    if (payload.status === 'closed' || payload.status === 'CLOSED') {
                        appState.positions.splice(idx, 1);
                        appState.closedPositions.unshift(payload);
                    } else {
                        appState.positions[idx] = payload;
                    }
                } else if (payload.status === 'open' || payload.status === 'OPEN') {
                    appState.positions.push(payload);
                }
                renderPositions();
                renderClosedPositions();
                updatePnLSummary();
            },
            onFundingRateUpdate: (payload) => {
                // Update or add funding rate
                const idx = appState.fundingRates.findIndex(
                    r => r.exchange === payload.exchange && r.pair === payload.symbol
                );
                const rate = {
                    exchange: payload.exchange,
                    pair: payload.symbol,
                    rate: payload.rate * 100,
                    predicted: payload.predicted_rate ? payload.predicted_rate * 100 : null,
                    nextFunding: payload.next_funding_time ?
                        Math.floor((new Date(payload.next_funding_time) - Date.now()) / 1000) : 0
                };
                if (idx >= 0) {
                    appState.fundingRates[idx] = rate;
                } else {
                    appState.fundingRates.push(rate);
                }
                renderFundingRates();
            },
            onTradeExecuted: (payload) => {
                showNotification(`Trade executed: ${payload.side} ${payload.size} ${payload.pair} on ${payload.exchange}`, 'info');
                loadPositions().then(() => {
                    renderPositions();
                    renderClosedPositions();
                    updatePnLSummary();
                });
            },
            onEngineStatus: (payload) => {
                appState.engineStatus = payload;
                renderEngineStatus();
            },
            onAlert: (payload) => {
                showNotification(payload.message, payload.severity || 'info');
            },
            onOpportunity: (payload) => {
                const idx = appState.opportunities.findIndex(
                    o => o.pair === payload.pair &&
                         o.long_exchange === payload.long_exchange &&
                         o.short_exchange === payload.short_exchange
                );
                if (idx >= 0) {
                    appState.opportunities[idx] = payload;
                } else {
                    appState.opportunities.unshift(payload);
                    if (appState.opportunities.length > 20) appState.opportunities.pop();
                }
                renderOpportunities();
            }
        };

        // ============================================================
        // Notification System
        // ============================================================
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            container.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // ============================================================
        // Initialize
        // ============================================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Initial UI setup with mock data
            renderFundingRates();
            renderPositions();
            renderClosedPositions();
            updatePnLSummary();
            initChart();
            calculateArbitrage();
            startCountdown();
            startClock();
            initTicker();
            renderEngineStatus();

            // Try to connect to backend
            wsManager = new WebSocketManager(CONFIG.WS_URL, wsHandlers);
            wsManager.connect();

            // Also try direct API load
            await loadAllData();
            renderFundingRates();
            renderPositions();
            renderClosedPositions();
            updatePnLSummary();

            // Periodic refresh
            setInterval(async () => {
                if (!useMockData) {
                    await loadAllData();
                    renderFundingRates();
                    renderPositions();
                    renderClosedPositions();
                    updatePnLSummary();
                }
            }, CONFIG.REFRESH_INTERVAL_MS);
        });

        // Clock
        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', { hour12: false });
            };
            update();
            setInterval(update, 1000);
        }

        // Ticker tape
        function initTicker() {
            const tickers = [
                { symbol: 'BTC', price: '94,521.00', change: '+2.34%', up: true },
                { symbol: 'ETH', price: '3,412.50', change: '+1.89%', up: true },
                { symbol: 'SOL', price: '189.30', change: '-0.52%', up: false },
                { symbol: 'ARB', price: '0.812', change: '+4.21%', up: true },
                { symbol: 'BNB', price: '702.40', change: '+0.95%', up: true },
                { symbol: 'DOGE', price: '0.321', change: '-1.23%', up: false },
            ];

            const content = tickers.map(t =>
                `<span class="ticker-item">
                    <span class="ticker-symbol">${t.symbol}</span>
                    <span class="ticker-price">${t.price}</span>
                    <span class="ticker-change ${t.up ? 'positive' : 'negative'}">${t.change}</span>
                </span>`
            ).join('');

            document.getElementById('ticker').innerHTML = content + content;
        }

        // Render funding rates
        function renderFundingRates() {
            const tbody = document.querySelector('#funding-table tbody');
            const rates = useMockData ? mockData.fundingRates : (appState.fundingRates.length ? appState.fundingRates : mockData.fundingRates);
            tbody.innerHTML = rates.map(item => {
                const apr = (item.rate * 3 * 365).toFixed(1);
                const rateClass = item.rate >= 0 ? 'positive' : 'negative';
                const tagClass = `tag-${item.exchange.toLowerCase()}`;
                return `
                    <tr>
                        <td><span class="exchange-tag ${tagClass}">${item.exchange.substring(0, 3).toUpperCase()}</span></td>
                        <td class="amber">${item.pair}</td>
                        <td class="${rateClass}">${item.rate >= 0 ? '+' : ''}${item.rate.toFixed(4)}%</td>
                        <td class="${item.predicted >= 0 ? 'positive' : 'negative'}">${item.predicted >= 0 ? '+' : ''}${item.predicted.toFixed(4)}%</td>
                        <td class="${rateClass}">${apr}%</td>
                        <td class="countdown-cell" data-seconds="${item.nextFunding}">--:--</td>
                    </tr>
                `;
            }).join('');
        }

        // Render positions
        function renderPositions() {
            const tbody = document.querySelector('#positions-table tbody');
            let positions;
            if (useMockData) {
                positions = mockData.positions.filter(p => p.status === 'active');
            } else {
                positions = appState.positions.length ? appState.positions : mockData.positions.filter(p => p.status === 'active');
            }

            tbody.innerHTML = positions.map(pos => {
                // Handle both API format and mock format
                const pair = pos.pair;
                const size = pos.size_usd || pos.size || 0;
                const longExchange = pos.long_exchange || pos.longExchange || '';
                const shortExchange = pos.short_exchange || pos.shortExchange || '';
                const entryDate = pos.entry_timestamp || pos.entryDate || '';
                const fundingCollected = pos.funding_collected || pos.fundingCollected || 0;
                const unrealizedPnl = pos.unrealized_pnl || pos.unrealizedPnl || 0;

                const pnlClass = unrealizedPnl >= 0 ? 'positive' : 'negative';
                const entryStr = typeof entryDate === 'string' ? entryDate.substring(5, 10) : new Date(entryDate).toLocaleDateString().substring(0, 5);

                return `
                    <tr>
                        <td class="amber">${pair}</td>
                        <td>$${(size/1000).toFixed(0)}K</td>
                        <td><span class="exchange-tag tag-${longExchange.toLowerCase()}">${longExchange.substring(0,3).toUpperCase()}</span></td>
                        <td><span class="exchange-tag tag-${shortExchange.toLowerCase()}">${shortExchange.substring(0,3).toUpperCase()}</span></td>
                        <td>${entryStr}</td>
                        <td class="positive">+$${fundingCollected.toFixed(0)}</td>
                        <td class="${pnlClass}">${unrealizedPnl >= 0 ? '+' : ''}$${unrealizedPnl.toFixed(0)}</td>
                        <td><button class="btn-close" onclick="closePosition('${pos.id}')">CLOSE</button></td>
                    </tr>
                `;
            }).join('');
        }

        // Render closed positions
        function renderClosedPositions() {
            const tbody = document.querySelector('#closed-positions-table tbody');
            let positions;
            if (useMockData) {
                positions = mockData.closedPositions;
            } else {
                positions = appState.closedPositions.length ? appState.closedPositions : mockData.closedPositions;
            }

            tbody.innerHTML = positions.slice(0, 20).map(pos => {
                // Handle both API format and mock format
                const pair = pos.pair;
                const size = pos.size_usd || pos.size || 0;
                const longExchange = pos.long_exchange || pos.longExchange || '';
                const shortExchange = pos.short_exchange || pos.shortExchange || '';
                const fundingCollected = pos.funding_collected || pos.fundingCollected || 0;
                const realizedPnl = pos.realized_pnl || pos.realizedPnl || 0;

                // Calculate duration
                let duration = pos.duration || '';
                if (!duration && pos.entry_timestamp && pos.close_timestamp) {
                    const entryDate = new Date(pos.entry_timestamp);
                    const closeDate = new Date(pos.close_timestamp);
                    const days = Math.floor((closeDate - entryDate) / (1000 * 60 * 60 * 24));
                    duration = `${days}d`;
                }

                const pnlClass = realizedPnl >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td class="amber">${pair}</td>
                        <td>$${(size/1000).toFixed(0)}K</td>
                        <td><span class="exchange-tag tag-${longExchange.toLowerCase()}">${longExchange.substring(0,3).toUpperCase()}</span></td>
                        <td><span class="exchange-tag tag-${shortExchange.toLowerCase()}">${shortExchange.substring(0,3).toUpperCase()}</span></td>
                        <td>${duration}</td>
                        <td class="positive">+$${fundingCollected.toFixed(0)}</td>
                        <td class="${pnlClass}">${realizedPnl >= 0 ? '+' : ''}$${realizedPnl.toFixed(0)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Update P&L summary
        function updatePnLSummary() {
            let unrealizedPnl, realizedPnl, fundingCollected;

            if (useMockData) {
                const activePositions = mockData.positions.filter(p => p.status === 'active');
                unrealizedPnl = activePositions.reduce((sum, p) => sum + p.unrealizedPnl, 0);
                fundingCollected = activePositions.reduce((sum, p) => sum + p.fundingCollected, 0) +
                                  mockData.closedPositions.reduce((sum, p) => sum + p.fundingCollected, 0);
                realizedPnl = mockData.closedPositions.reduce((sum, p) => sum + p.realizedPnl, 0);
            } else if (appState.stats) {
                unrealizedPnl = 0; // Would need to calculate from positions
                realizedPnl = appState.stats.total_realized_pnl || 0;
                fundingCollected = appState.stats.total_funding_collected || 0;
                // Calculate unrealized from positions
                unrealizedPnl = appState.positions.reduce((sum, p) => sum + (p.unrealized_pnl || 0), 0);
            } else {
                const activePositions = appState.positions.length ? appState.positions : mockData.positions.filter(p => p.status === 'active');
                const closedPositions = appState.closedPositions.length ? appState.closedPositions : mockData.closedPositions;
                unrealizedPnl = activePositions.reduce((sum, p) => sum + (p.unrealized_pnl || p.unrealizedPnl || 0), 0);
                fundingCollected = activePositions.reduce((sum, p) => sum + (p.funding_collected || p.fundingCollected || 0), 0) +
                                  closedPositions.reduce((sum, p) => sum + (p.funding_collected || p.fundingCollected || 0), 0);
                realizedPnl = closedPositions.reduce((sum, p) => sum + (p.realized_pnl || p.realizedPnl || 0), 0);
            }

            const netPnl = unrealizedPnl + realizedPnl;

            updatePnLCard('unrealized-pnl', unrealizedPnl);
            updatePnLCard('realized-pnl', realizedPnl);
            updatePnLCard('funding-collected', fundingCollected);
            updatePnLCard('net-pnl', netPnl);
        }

        function updatePnLCard(id, value) {
            const el = document.getElementById(id);
            el.textContent = `${value >= 0 ? '+' : ''}$${value.toFixed(2)}`;
            el.className = `pnl-value ${value >= 0 ? 'positive' : 'negative'}`;
        }

        // Calculator
        function calculateArbitrage() {
            const size = parseFloat(document.getElementById('calc-size').value) || 0;
            const leverage = parseFloat(document.getElementById('calc-leverage').value) || 1;
            const longRate = parseFloat(document.getElementById('calc-long-rate').value) || 0;
            const shortRate = parseFloat(document.getElementById('calc-short-rate').value) || 0;

            const spread = shortRate - longRate;
            const effectiveSize = size * leverage;
            const perFunding = (effectiveSize * spread) / 100;
            const daily = perFunding * 3;
            const weekly = daily * 7;
            const monthly = daily * 30;
            const apr = spread * 3 * 365;

            const isPositive = spread >= 0;
            const cls = isPositive ? 'positive' : 'negative';

            document.getElementById('calc-spread').textContent = `${spread.toFixed(4)}%`;
            document.getElementById('calc-spread').className = `calc-result-value ${cls}`;

            document.getElementById('calc-per-funding').textContent = `$${perFunding.toFixed(2)}`;
            document.getElementById('calc-per-funding').className = `calc-result-value ${cls}`;

            document.getElementById('calc-daily').textContent = `$${daily.toFixed(2)}`;
            document.getElementById('calc-daily').className = `calc-result-value ${cls}`;

            document.getElementById('calc-weekly').textContent = `$${weekly.toFixed(2)}`;
            document.getElementById('calc-weekly').className = `calc-result-value ${cls}`;

            document.getElementById('calc-monthly').textContent = `$${monthly.toFixed(2)}`;
            document.getElementById('calc-monthly').className = `calc-result-value ${cls}`;

            document.getElementById('calc-apr').textContent = `${apr.toFixed(2)}%`;
        }

        // Close position
        async function closePosition(id) {
            if (useMockData) {
                const pos = mockData.positions.find(p => p.id === parseInt(id));
                if (pos) {
                    pos.status = 'closed';
                    const realized = pos.fundingCollected + pos.unrealizedPnl;
                    mockData.closedPositions.unshift({
                        ...pos,
                        duration: `${Math.floor((Date.now() - new Date(pos.entryDate).getTime()) / (1000 * 60 * 60 * 24))}d`,
                        realizedPnl: realized
                    });
                    renderPositions();
                    renderClosedPositions();
                    updatePnLSummary();
                }
            } else {
                try {
                    if (!confirm('Are you sure you want to close this position?')) return;
                    await api.closePosition(id, 'manual');
                    showNotification('Position close request sent', 'info');
                    await loadPositions();
                    renderPositions();
                    renderClosedPositions();
                    updatePnLSummary();
                } catch (error) {
                    showNotification(`Failed to close position: ${error.message}`, 'error');
                    console.error('Failed to close position:', error);
                }
            }
        }

        // ============================================================
        // Engine Control Functions
        // ============================================================
        async function startEngine() {
            try {
                await api.startEngine();
                showNotification('Engine start request sent', 'info');
                await loadEngineStatus();
            } catch (error) {
                showNotification(`Failed to start engine: ${error.message}`, 'error');
            }
        }

        async function stopEngine() {
            try {
                await api.stopEngine();
                showNotification('Engine stop request sent', 'info');
                await loadEngineStatus();
            } catch (error) {
                showNotification(`Failed to stop engine: ${error.message}`, 'error');
            }
        }

        async function activateKillSwitch() {
            if (!confirm('DANGER: This will close ALL positions and halt trading. Are you absolutely sure?')) return;
            if (!confirm('FINAL WARNING: This action cannot be undone automatically. Confirm kill switch activation?')) return;

            try {
                await api.activateKillSwitch('manual_dashboard');
                showNotification('KILL SWITCH ACTIVATED', 'critical');
                await loadEngineStatus();
            } catch (error) {
                showNotification(`Failed to activate kill switch: ${error.message}`, 'error');
            }
        }

        async function forceScan() {
            try {
                await api.forceScan();
                showNotification('Scan triggered', 'info');
            } catch (error) {
                showNotification(`Failed to trigger scan: ${error.message}`, 'error');
            }
        }

        // ============================================================
        // Render Engine Status
        // ============================================================
        function renderEngineStatus() {
            const statusEl = document.getElementById('engine-status-panel');
            if (!statusEl) return;

            const status = appState.engineStatus || {
                state: 'UNKNOWN',
                simulation_mode: true,
                connected_exchanges: [],
                monitored_symbols: [],
                open_positions: 0,
                pending_orders: 0,
                kill_switch_active: false,
                error_message: null
            };

            const stateClass = {
                'RUNNING': 'positive',
                'STOPPED': 'negative',
                'STARTING': 'amber',
                'STOPPING': 'amber',
                'ERROR': 'negative',
                'UNKNOWN': 'text-gray'
            }[status.state] || 'text-gray';

            const killSwitchClass = status.kill_switch_active ? 'negative blink' : 'positive';

            statusEl.innerHTML = `
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">STATE</span>
                        <span class="status-value ${stateClass}">${status.state}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">MODE</span>
                        <span class="status-value ${status.simulation_mode ? 'amber' : 'positive'}">${status.simulation_mode ? 'SIMULATION' : 'LIVE'}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">KILL SWITCH</span>
                        <span class="status-value ${killSwitchClass}">${status.kill_switch_active ? 'ACTIVE' : 'OFF'}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">EXCHANGES</span>
                        <span class="status-value">${(status.connected_exchanges || []).length}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">SYMBOLS</span>
                        <span class="status-value">${(status.monitored_symbols || []).length}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">POSITIONS</span>
                        <span class="status-value">${status.open_positions || 0}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">PENDING</span>
                        <span class="status-value">${status.pending_orders || 0}</span>
                    </div>
                </div>
                ${status.error_message ? `<div class="status-error">${status.error_message}</div>` : ''}
            `;
        }

        // ============================================================
        // Render Opportunities
        // ============================================================
        function renderOpportunities() {
            const tbody = document.querySelector('#opportunities-table tbody');
            if (!tbody) return;

            if (appState.opportunities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-gray">No opportunities detected</td></tr>';
                return;
            }

            tbody.innerHTML = appState.opportunities.slice(0, 10).map(opp => {
                const spreadPct = (opp.spread * 100).toFixed(4);
                const apr = (opp.spread * 3 * 365 * 100).toFixed(1);
                return `
                    <tr>
                        <td class="amber">${opp.pair || opp.symbol}</td>
                        <td><span class="exchange-tag tag-${(opp.long_exchange || '').toLowerCase()}">${(opp.long_exchange || '').substring(0,3).toUpperCase()}</span></td>
                        <td><span class="exchange-tag tag-${(opp.short_exchange || '').toLowerCase()}">${(opp.short_exchange || '').substring(0,3).toUpperCase()}</span></td>
                        <td class="positive">+${spreadPct}%</td>
                        <td class="positive">${apr}%</td>
                        <td class="${opp.recommended_size ? '' : 'text-gray'}">${opp.recommended_size ? `$${(opp.recommended_size/1000).toFixed(0)}K` : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Chart
        function initChart() {
            const ctx = document.getElementById('fundingChart').getContext('2d');
            const data = mockData.historicalRates.BTC;

            fundingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Binance',
                            data: data.binance,
                            borderColor: '#f0b90b',
                            backgroundColor: 'transparent',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Bybit',
                            data: data.bybit,
                            borderColor: '#f7a600',
                            backgroundColor: 'transparent',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'dYdX',
                            data: data.dydx,
                            borderColor: '#6966ff',
                            backgroundColor: 'transparent',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#888899',
                                usePointStyle: true,
                                pointStyle: 'line',
                                padding: 15,
                                font: { family: "'IBM Plex Mono'", size: 10 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1a2e',
                            titleColor: '#ffcc00',
                            bodyColor: '#ffffff',
                            borderColor: '#2a2a3a',
                            borderWidth: 1,
                            padding: 8,
                            titleFont: { family: "'IBM Plex Mono'", size: 10 },
                            bodyFont: { family: "'IBM Plex Mono'", size: 10 },
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y >= 0 ? '+' : ''}${ctx.parsed.y.toFixed(4)}%`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#1a1a25', drawBorder: false },
                            ticks: { color: '#555566', font: { family: "'IBM Plex Mono'", size: 9 } }
                        },
                        y: {
                            grid: { color: '#1a1a25', drawBorder: false },
                            ticks: {
                                color: '#555566',
                                font: { family: "'IBM Plex Mono'", size: 9 },
                                callback: v => `${v >= 0 ? '+' : ''}${v.toFixed(3)}%`
                            }
                        }
                    }
                }
            });
        }

        function updateChart(pair) {
            const data = mockData.historicalRates[pair];
            if (!data) return;

            fundingChart.data.labels = data.labels;
            fundingChart.data.datasets[0].data = data.binance;
            fundingChart.data.datasets[1].data = data.bybit;
            fundingChart.data.datasets[2].data = data.dydx;
            fundingChart.update('active');

            document.querySelectorAll('.chart-tab').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === pair);
            });
        }

        // Countdown
        function startCountdown() {
            setInterval(() => {
                document.querySelectorAll('.countdown-cell[data-seconds]').forEach(el => {
                    let seconds = parseInt(el.dataset.seconds);
                    if (seconds > 0) {
                        seconds--;
                        el.dataset.seconds = seconds;
                        const h = Math.floor(seconds / 3600);
                        const m = Math.floor((seconds % 3600) / 60);
                        const s = seconds % 60;
                        el.textContent = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                        el.classList.toggle('urgent', seconds < 300);
                    }
                });
            }, 1000);
        }

        // Auto-calculate
        document.querySelectorAll('#calc-size, #calc-leverage, #calc-long-rate, #calc-short-rate').forEach(el => {
            el.addEventListener('input', calculateArbitrage);
        });

        // Command input
        document.getElementById('commandInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const cmd = e.target.value.toUpperCase();
                if (cmd.includes('BTC')) updateChart('BTC');
                else if (cmd.includes('ETH')) updateChart('ETH');
                else if (cmd.includes('SOL')) updateChart('SOL');
                else if (cmd.includes('ARB')) updateChart('ARB');
                e.target.value = '';
            }
        });
    </script>
</body>
</html>
